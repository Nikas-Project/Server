{"version":3,"file":"embed.dev.js","mappings":";;;;;;;;;AAAA,QAAQ,mBAAO,CAAC,sDAAiB;AACjC,cAAc,mBAAO,CAAC,8CAAa;;AAEnC;;AAEA;AACA,6BAA6B;;AAE7B;AACA;;AAEA;AACA,gBAAgB,eAAe;AAC/B;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,gBAAgB,eAAe;AAC/B;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,UAAU;AACV,sBAAsB,4CAA4C;AAClE;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,4CAA4C;AAC5C;;AAEA;AACA;AACA,2CAA2C,wBAAwB;AACnE;AACA;AACA;AACA,cAAc;AACd;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA,UAAU;AACV;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA,UAAU;AACV;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA,oDAAoD,cAAc;AAClE,wBAAwB,wCAAwC;AAChE;AACA;;AAEA;AACA,0CAA0C;AAC1C,iDAAiD;AACjD,2CAA2C;;AAE3C,uBAAuB;;AAEvB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd,mCAAmC,kBAAkB;AACrD,cAAc;AACd;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,wBAAwB,wCAAwC;AAChE;AACA;;AAEA;AACA;AACA;AACA,wBAAwB,wCAAwC;AAChE;AACA;;;AAGA;AACA,sCAAsC,wBAAwB;AAC9D;;AAEA;AACA;AACA,yDAAyD,YAAY;AACrE;AACA;AACA;AACA,cAAc;AACd;AACA;AACA,SAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;ACjOA,YAAY,mBAAO,CAAC,0CAAW;;AAE/B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,gBAAgB,eAAe;AAC/B,oBAAoB,6BAA6B;AACjD;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB,gCAAgC;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;ACnFA,UAAU,mBAAO,CAAC,sCAAS;AAC3B,QAAQ,mBAAO,CAAC,sCAAS;AACzB,WAAW,mBAAO,CAAC,wCAAU;;AAE7B;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,UAAU;AACV;AACA;AACA,KAAK;;AAEL;;AAEA;AACA;AACA;;AAEA;;AAEA,gCAAgC,sBAAsB;AACtD;AACA;AACA;AACA;AACA,KAAK;AACL;;;;;;;;;;;;ACtCa;;AAEb;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,8BAA8B;AAC9B,+BAA+B;AAC/B,4CAA4C;;AAE5C,iCAAiC;;AAEjC,gDAAgD;AAChD,yCAAyC;;AAEzC;;AAEA;AACA;AACA,+BAA+B,0BAA0B;AACzD,0CAA0C;AAC1C,SAAS;AACT;AACA,+BAA+B,wBAAwB;AACvD,wCAAwC;AACxC,SAAS;AACT;AACA,+BAA+B,oBAAoB;AACnD,oCAAoC;AACpC,SAAS;AACT;AACA,+BAA+B,0BAA0B;AACzD,0CAA0C;AAC1C;AACA,KAAK;AACL;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,qDAAqD,wBAAwB;;AAE7E;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;AC/Na;;AAEb;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,0BAA0B,eAAe;AACzC;;AAEA;;AAEA;AACA;AACA;;;;;;;;;;;ACnBA,aAAa,mBAAO,CAAC,4CAAY;;AAEjC,SAAS,mBAAO,CAAC,8CAAa;;AAE9B;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,gBAAgB,yBAAyB;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,iCAAiC,IAAI;AACrC;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;AC5FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,gCAAgC,KAAK;AACrC;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B,KAAK;;AAE/B;AACA,qCAAqC,KAAK;AAC1C,kCAAkC,KAAK;AACvC,2BAA2B,KAAK;AAChC,+BAA+B,KAAK;AACpC,+BAA+B,KAAK;AACpC,8BAA8B,KAAK;AACnC;;;;;;;;;;;ACjCA,QAAQ,mBAAO,CAAC,sDAAiB;;AAEjC;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA,wBAAwB,yBAAyB;AACjD,4BAA4B,UAAU;AACtC;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,2CAA2C;;AAE3C;AACA;;AAEA;AACA;AACA;AACA;;;;;;;;;;;;AC3Fa;;AAEb;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT,KAAK;;AAEL;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT,KAAK;AACL;;AAEA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;;;;;;;;;;AC1Da;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;ACzBA,QAAQ,mBAAO,CAAC,sCAAS;AACzB,YAAY,mBAAO,CAAC,0CAAW;AAC/B,aAAa,mBAAO,CAAC,4CAAY;AACjC,UAAU,mBAAO,CAAC,sCAAS;AAC3B,eAAe,mBAAO,CAAC,gDAAc;AACrC,WAAW,mBAAO,CAAC,wCAAU;AAC7B,iBAAiB,mBAAO,CAAC,4DAAoB;AAC7C,cAAc,mBAAO,CAAC,8CAAa;;AAEnC;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;;AAET;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;AACA,SAAS;AACT,KAAK;;AAEL;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,2DAA2D,oBAAoB;;AAE/E;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;;AAErB;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA,iBAAiB;AACjB,KAAK;AACL;;AAEA;AACA,oDAAoD,oBAAoB;;AAExE;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,MAAM;AACN;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,sBAAsB;AACtB;AACA;AACA;AACA,2CAA2C;AAC3C;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA,oCAAoC,4BAA4B;AAChE;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,aAAa;AACb,SAAS;;AAET;AACA;AACA;AACA,aAAa;AACb,SAAS;;AAET;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,aAAa;;AAEb;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,aAAa;;AAEb;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,kBAAkB;AAClB,6CAA6C,wCAAwC;AACrF;AACA;AACA,qBAAqB;AACrB;AACA,cAAc;AACd;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,kBAAkB;AAClB;AACA,+CAA+C;AAC/C;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV,qCAAqC,gBAAgB;AACrD;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,qCAAqC,WAAW;AAChD,UAAU;AACV;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAAS;AACT;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;AChaA;AACA,kBAAkB,mBAAO,CAAC,iEAAwB;AAClD,gBAAgB,mBAAO,CAAC,6DAAsB;AAC9C;;;;;;;;;;;ACHA,YAAY,mBAAO,CAAC,0CAAW;;AAE/B,mBAAmB,mBAAO,CAAC,kEAAuB;AAClD,mBAAmB,mBAAO,CAAC,kEAAuB;AAClD,0BAA0B,mBAAO,CAAC,gFAA8B;;AAEhE;;AAEA,gBAAgB;AAChB;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,6BAA6B,4BAA4B;AACzD;AACA;AACA;AACA;;AAEA;AACA,CAAC;AACD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,oBAAoB,iBAAiB;AACrC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;;;;;;;;;;ACjFA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;ACfA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;;;;;;;;;;AClFA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACtEa;;AAEb;AACA;AACA,wCAAwC,oBAAoB;AAC5D;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,eAAe;AACf,cAAc;AACd,cAAc;AACd,gBAAgB;AAChB,eAAe;AACf,gBAAgB;AAChB;;AAEA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA,wBAAwB;AACxB;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAoB,oBAAoB;AACxC;AACA;AACA,UAAU;AACV;AACA,UAAU;AACV;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA,KAAK,IAAI;AACT;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;UCrGA;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;;;;;ACtBA,eAAe,mBAAO,CAAC,kDAAe;AACtC,aAAa,mBAAO,CAAC,4CAAY;AACjC,WAAW,mBAAO,CAAC,wCAAU;AAC7B,UAAU,mBAAO,CAAC,sCAAS;AAC3B,YAAY,mBAAO,CAAC,0CAAW;AAC/B,YAAY,mBAAO,CAAC,0CAAW;AAC/B,QAAQ,mBAAO,CAAC,sCAAS;AACzB,UAAU,mBAAO,CAAC,sCAAS;AAC3B,eAAe,mBAAO,CAAC,gDAAc;;AAErC;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA","sources":["webpack://nikas/./nikas/js/app/api.js","webpack://nikas/./nikas/js/app/config.js","webpack://nikas/./nikas/js/app/count.js","webpack://nikas/./nikas/js/app/dom.js","webpack://nikas/./nikas/js/app/globals.js","webpack://nikas/./nikas/js/app/i18n.js","webpack://nikas/./nikas/js/app/i18n/fa.js","webpack://nikas/./nikas/js/app/lib/identicons.js","webpack://nikas/./nikas/js/app/lib/promise.js","webpack://nikas/./nikas/js/app/lib/ready.js","webpack://nikas/./nikas/js/app/nikas.js","webpack://nikas/./nikas/js/app/svg.js","webpack://nikas/./nikas/js/app/template.js","webpack://nikas/./nikas/js/app/templates/comment-loader.js","webpack://nikas/./nikas/js/app/templates/comment.js","webpack://nikas/./nikas/js/app/templates/postbox.js","webpack://nikas/./nikas/js/app/utils.js","webpack://nikas/webpack/bootstrap","webpack://nikas/./nikas/js/embed.js"],"sourcesContent":["var Q = require(\"app/lib/promise\");\nvar globals = require(\"app/globals\");\n\n\"use strict\";\n\nvar salt = \"Eech7co8Ohloopo9Ol6baimi\",\n    location = function () { return window.location.pathname };\n\nvar script, endpoint,\n    js = document.getElementsByTagName(\"script\");\n\n// prefer `data-nikas=\"//host/api/endpoint\"` if provided\nfor (var i = 0; i < js.length; i++) {\n    if (js[i].hasAttribute(\"data-nikas\")) {\n        endpoint = js[i].getAttribute(\"data-nikas\");\n        break;\n    }\n}\n\n// if no async-script is embedded, use the last script tag of `js`\nif (!endpoint) {\n    for (i = 0; i < js.length; i++) {\n        if (js[i].getAttribute(\"async\") || js[i].getAttribute(\"defer\")) {\n            throw \"Nikas's automatic configuration detection failed, please \" +\n            \"refer to https://docs.nikasproject.ir/config/client.html \" +\n            \"and add a custom `data-nikas` attribute.\";\n        }\n    }\n\n    script = js[js.length - 1];\n    endpoint = script.src.substring(0, script.src.length - \"/js/embed.min.js\".length);\n}\n\n//  strip trailing slash\nif (endpoint[endpoint.length - 1] === \"/\") {\n    endpoint = endpoint.substring(0, endpoint.length - 1);\n}\n\nvar curl = function (method, url, data, resolve, reject) {\n\n    var xhr = new XMLHttpRequest();\n\n    function onload () {\n\n        var date = xhr.getResponseHeader(\"Date\");\n        if (date !== null) {\n            globals.offset.update(new Date(date));\n        }\n\n        var cookie = xhr.getResponseHeader(\"X-Set-Cookie\");\n        if (cookie && cookie.match(/^nikas-/)) {\n            document.cookie = cookie;\n        }\n\n        if (xhr.status >= 500) {\n            if (reject) {\n                reject(xhr.body);\n            }\n        } else {\n            resolve({ status: xhr.status, body: xhr.responseText });\n        }\n    }\n\n    try {\n        xhr.open(method, url, true);\n        xhr.withCredentials = true;\n        xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n\n        xhr.onreadystatechange = function () {\n            if (xhr.readyState === 4) {\n                onload();\n            }\n        };\n    } catch (exception) {\n        (reject || console.log)(exception.message);\n    }\n\n    xhr.send(data);\n};\n\nvar qs = function (params) {\n    var rv = \"\";\n    for (var key in params) {\n        if (params.hasOwnProperty(key) &&\n            params[key] !== null && typeof (params[key]) !== \"undefined\") {\n            rv += key + \"=\" + encodeURIComponent(params[key]) + \"&\";\n        }\n    }\n\n    return rv.substring(0, rv.length - 1);  // chop off trailing \"&\"\n};\n\nvar create = function (tid, data) {\n    var deferred = Q.defer();\n    curl(\"POST\", endpoint + \"/new?\" + qs({ uri: tid || location() }), JSON.stringify(data),\n        function (rv) {\n            if (rv.status === 201 || rv.status === 202) {\n                deferred.resolve(JSON.parse(rv.body));\n            } else {\n                deferred.reject(rv.body);\n            }\n        });\n    return deferred.promise;\n};\n\nvar modify = function (id, data) {\n    var deferred = Q.defer();\n    curl(\"PUT\", endpoint + \"/id/\" + id, JSON.stringify(data), function (rv) {\n        if (rv.status === 403) {\n            deferred.reject(\"Not authorized to modify this comment!\");\n        } else if (rv.status === 200) {\n            deferred.resolve(JSON.parse(rv.body));\n        } else {\n            deferred.reject(rv.body);\n        }\n    });\n    return deferred.promise;\n};\n\nvar remove = function (id) {\n    var deferred = Q.defer();\n    curl(\"DELETE\", endpoint + \"/id/\" + id, null, function (rv) {\n        if (rv.status === 403) {\n            deferred.reject(\"Not authorized to remove this comment!\");\n        } else if (rv.status === 200) {\n            deferred.resolve(JSON.parse(rv.body) === null);\n        } else {\n            deferred.reject(rv.body);\n        }\n    });\n    return deferred.promise;\n};\n\nvar view = function (id, plain) {\n    var deferred = Q.defer();\n    curl(\"GET\", endpoint + \"/id/\" + id + \"?\" + qs({ plain: plain }), null,\n        function (rv) { deferred.resolve(JSON.parse(rv.body)); });\n    return deferred.promise;\n};\n\nvar fetch = function (tid, limit, nested_limit, parent, lastcreated) {\n    if (typeof (limit) === 'undefined') { limit = \"inf\"; }\n    if (typeof (nested_limit) === 'undefined') { nested_limit = \"inf\"; }\n    if (typeof (parent) === 'undefined') { parent = null; }\n\n    var query_dict = { uri: tid || location(), after: lastcreated, parent: parent };\n\n    if (limit !== \"inf\") {\n        query_dict['limit'] = limit;\n    }\n    if (nested_limit !== \"inf\") {\n        query_dict['nested_limit'] = nested_limit;\n    }\n\n    var deferred = Q.defer();\n    curl(\"GET\", endpoint + \"/?\" +\n        qs(query_dict), null, function (rv) {\n            if (rv.status === 200) {\n                deferred.resolve(JSON.parse(rv.body));\n            } else if (rv.status === 404) {\n                deferred.resolve({ total_replies: 0 });\n            } else {\n                deferred.reject(rv.body);\n            }\n        });\n    return deferred.promise;\n};\n\nvar count = function (urls) {\n    var deferred = Q.defer();\n    curl(\"POST\", endpoint + \"/count\", JSON.stringify(urls), function (rv) {\n        if (rv.status === 200) {\n            deferred.resolve(JSON.parse(rv.body));\n        } else {\n            deferred.reject(rv.body);\n        }\n    });\n    return deferred.promise;\n};\n\nvar like = function (id) {\n    var deferred = Q.defer();\n    curl(\"POST\", endpoint + \"/id/\" + id + \"/like\", null,\n        function (rv) { deferred.resolve(JSON.parse(rv.body)); });\n    return deferred.promise;\n};\n\nvar dislike = function (id) {\n    var deferred = Q.defer();\n    curl(\"POST\", endpoint + \"/id/\" + id + \"/dislike\", null,\n        function (rv) { deferred.resolve(JSON.parse(rv.body)); });\n    return deferred.promise;\n};\n\n\nvar feed = function (tid) {\n    return endpoint + \"/feed?\" + qs({ uri: tid || location() });\n};\n\nvar preview = function (text) {\n    var deferred = Q.defer();\n    curl(\"POST\", endpoint + \"/preview\", JSON.stringify({ text: text }),\n        function (rv) {\n            if (rv.status === 200) {\n                deferred.resolve(JSON.parse(rv.body).text);\n            } else {\n                deferred.reject(rv.body);\n            }\n        });\n    return deferred.promise;\n};\n\nmodule.exports = {\n    endpoint: endpoint,\n    salt: salt,\n    create: create,\n    modify: modify,\n    remove: remove,\n    view: view,\n    fetch: fetch,\n    count: count,\n    like: like,\n    dislike: dislike,\n    feed: feed,\n    preview: preview,\n};\n","var utils = require(\"app/utils\");\n\n\"use strict\";\n\nvar config = {\n    \"css\": true,\n    \"css-url\": null,\n    \"lang\": \"\",\n    \"default-lang\": \"fa\",\n    \"reply-to-self\": false,\n    \"require-email\": false,\n    \"require-author\": false,\n    \"reply-notifications\": false,\n    \"max-comments-top\": \"inf\",\n    \"max-comments-nested\": 5,\n    \"reveal-on-click\": 5,\n    \"gravatar\": false,\n    \"avatar\": true,\n    \"avatar-bg\": \"#f0f0f0\",\n    \"avatar-fg\": [\"#9abf88\", \"#5698c4\", \"#e279a3\", \"#9163b6\",\n        \"#be5168\", \"#f19670\", \"#e4bf80\", \"#447c69\"].join(\" \"),\n    \"vote\": true,\n    \"vote-levels\": null,\n    \"feed\": false\n};\n\nvar js = document.getElementsByTagName(\"script\");\n\nfor (var i = 0; i < js.length; i++) {\n    for (var j = 0; j < js[i].attributes.length; j++) {\n        var attr = js[i].attributes[j];\n        if (/^data-nikas-/.test(attr.name)) {\n            try {\n                config[attr.name.substring(10)] = JSON.parse(attr.value);\n            } catch (ex) {\n                config[attr.name.substring(10)] = attr.value;\n            }\n        }\n    }\n}\n\n// split avatar-fg on whitespace\nconfig[\"avatar-fg\"] = config[\"avatar-fg\"].split(\" \");\n\n// create an array of normalized language codes from:\n//   - config[\"lang\"], if it is nonempty\n//   - the first of navigator.languages, navigator.language, and\n//     navigator.userLanguage that exists and has a nonempty value\n//   - config[\"default-lang\"]\n//   - \"en\" as an ultimate fallback\n// i18n.js will use the first code in this array for which we have\n// a translation.\nvar languages = [];\nvar found_navlang = false;\nif (config[\"lang\"]) {\n    languages.push(utils.normalize_bcp47(config[\"lang\"]));\n}\nif (navigator.languages) {\n    for (i = 0; i < navigator.languages.length; i++) {\n        if (navigator.languages[i]) {\n            found_navlang = true;\n            languages.push(utils.normalize_bcp47(navigator.languages[i]));\n        }\n    }\n}\nif (!found_navlang && navigator.language) {\n    found_navlang = true;\n    languages.push(utils.normalize_bcp47(navigator.language));\n}\nif (!found_navlang && navigator.userLanguage) {\n    found_navlang = true;\n    languages.push(utils.normalize_bcp47(navigator.userLanguage));\n}\nif (config[\"default-lang\"]) {\n    languages.push(utils.normalize_bcp47(config[\"default-lang\"]));\n}\nlanguages.push(\"fa\");\n\nconfig[\"langs\"] = languages;\n// code outside this file should look only at langs\ndelete config[\"lang\"];\ndelete config[\"default-lang\"];\n\nmodule.exports = config;\n","var api = require(\"app/api\");\nvar $ = require(\"app/dom\");\nvar i18n = require(\"app/i18n\");\n\nmodule.exports = function () {\n\n    var objs = {};\n\n    $.each(\"a\", function (el) {\n        if (!el.href.match || !el.href.match(/#nikas-thread$/)) {\n            return;\n        }\n\n        var tid = el.getAttribute(\"data-nikas-id\") ||\n            el.href.match(/^(.+)#nikas-thread$/)[1]\n                .replace(/^.*\\/\\/[^\\/]+/, '');\n\n        if (tid in objs) {\n            objs[tid].push(el);\n        } else {\n            objs[tid] = [el];\n        }\n    });\n\n    var urls = Object.keys(objs);\n\n    api.count(urls).then(function (rv) {\n        for (var key in objs) {\n            if (objs.hasOwnProperty(key)) {\n\n                var index = urls.indexOf(key);\n\n                for (var i = 0; i < objs[key].length; i++) {\n                    objs[key][i].textContent = i18n.pluralize(\"num-comments\", rv[index]);\n                }\n            }\n        }\n    });\n};\n","\"use strict\";\n\nfunction Element (node) {\n    this.obj = node;\n\n    this.replace = function (el) {\n        var element = DOM.htmlify(el);\n        node.parentNode.replaceChild(element.obj, node);\n        return element;\n    };\n\n    this.prepend = function (el) {\n        var element = DOM.htmlify(el);\n        node.insertBefore(element.obj, node.firstChild);\n        return element;\n    };\n\n    this.append = function (el) {\n        var element = DOM.htmlify(el);\n        node.appendChild(element.obj);\n        return element;\n    };\n\n    this.insertAfter = function (el) {\n        var element = DOM.htmlify(el);\n        node.parentNode.insertBefore(element.obj, node.nextSibling);\n        return element;\n    };\n\n    /**\n     * Shortcut for `Element.addEventListener`, prevents default event\n     * by default, set :param prevents: to `false` to change that behavior.\n     */\n    this.on = function (type, listener, prevent) {\n        node.addEventListener(type, function (event) {\n            listener(event);\n            if (prevent === undefined || prevent) {\n                event.preventDefault();\n            }\n        });\n    };\n\n    /**\n     * Toggle between two internal states on event :param type: e.g. to\n     * cycle form visibility. Callback :param a: is called on first event,\n     * :param b: next time.\n     *\n     * You can skip to the next state without executing the callback with\n     * `toggler.next()`. You can prevent a cycle when you call `toggler.wait()`\n     * during an event.\n     */\n    this.toggle = function (type, a, b) {\n\n        var toggler = new Toggle(a, b);\n        this.on(type, function () {\n            toggler.next();\n        });\n    };\n\n    this.detach = function () {\n        // Detach an element from the DOM and return it.\n        node.parentNode.removeChild(this.obj);\n        return this;\n    };\n\n    this.remove = function () {\n        // IE quirks\n        node.parentNode.removeChild(this.obj);\n    };\n\n    this.show = function () {\n        node.style.display = \"block\";\n    };\n\n    this.hide = function () {\n        node.style.display = \"none\";\n    };\n\n    this.setText = function (text) {\n        node.textContent = text;\n    };\n\n    this.setHtml = function (html) {\n        node.innerHTML = html;\n    };\n\n    this.blur = function () { node.blur() };\n    this.focus = function () { node.focus() };\n    this.scrollIntoView = function (args) { node.scrollIntoView(args) };\n\n    this.checked = function () { return node.checked; };\n\n    this.setAttribute = function (key, value) { node.setAttribute(key, value) };\n    this.getAttribute = function (key) { return node.getAttribute(key) };\n\n    this.classList = node.classList;\n\n    Object.defineProperties(this, {\n        \"textContent\": {\n            get: function () { return node.textContent; },\n            set: function (textContent) { node.textContent = textContent; }\n        },\n        \"innerHTML\": {\n            get: function () { return node.innerHTML; },\n            set: function (innerHTML) { node.innerHTML = innerHTML; }\n        },\n        \"value\": {\n            get: function () { return node.value; },\n            set: function (value) { node.value = value; }\n        },\n        \"placeholder\": {\n            get: function () { return node.placeholder; },\n            set: function (placeholder) { node.placeholder = placeholder; }\n        }\n    });\n}\n\nvar Toggle = function (a, b) {\n    this.state = false;\n\n    this.next = function () {\n        if (!this.state) {\n            this.state = true;\n            a(this);\n        } else {\n            this.state = false;\n            b(this);\n        }\n    };\n\n    this.wait = function () {\n        this.state = !this.state;\n    };\n};\n\nvar DOM = function (query, root, single) {\n    /*\n    jQuery-like CSS selector which returns on :param query: either a\n    single node (unless single=false), a node list or null.\n\n    :param root: only queries within the given element.\n     */\n\n    if (typeof single === \"undefined\") {\n        single = true;\n    }\n\n    if (!root) {\n        root = window.document;\n    }\n\n    if (root instanceof Element) {\n        root = root.obj;\n    }\n    var elements = [].slice.call(root.querySelectorAll(query), 0);\n\n    if (elements.length === 0) {\n        return null;\n    }\n\n    if (elements.length === 1 && single) {\n        return new Element(elements[0]);\n    }\n\n    // convert NodeList to Array\n    elements = [].slice.call(elements, 0);\n\n    return elements.map(function (el) {\n        return new Element(el);\n    });\n};\n\nDOM.htmlify = function (el) {\n    /*\n    Convert :param html: into an Element (if not already).\n    */\n\n    if (el instanceof Element) {\n        return el;\n    }\n\n    if (el instanceof window.Element) {\n        return new Element(el);\n    }\n\n    var wrapper = DOM.new(\"div\");\n    wrapper.innerHTML = el;\n    return new Element(wrapper.firstChild);\n};\n\nDOM.new = function (tag, content) {\n    /*\n    A helper to build HTML with pure JS. You can pass class names and\n    default content as well:\n\n        var par = DOM.new(\"p\"),\n            div = DOM.new(\"p.some.classes\"),\n            div = DOM.new(\"textarea.foo\", \"...\")\n     */\n\n    var el = document.createElement(tag.split(\".\")[0]);\n    tag.split(\".\").slice(1).forEach(function (val) { el.classList.add(val); });\n\n    if ([\"A\", \"LINK\"].indexOf(el.nodeName) > -1) {\n        el.href = \"#\";\n    }\n\n    if (!content && content !== 0) {\n        content = \"\";\n    }\n    if ([\"TEXTAREA\", \"INPUT\"].indexOf(el.nodeName) > -1) {\n        el.value = content;\n    } else {\n        el.textContent = content;\n    }\n    return el;\n};\n\nDOM.each = function (tag, func) {\n    // XXX really needed? Maybe better as NodeList method\n    Array.prototype.forEach.call(document.getElementsByTagName(tag), func);\n};\n\nmodule.exports = DOM;\n","\"use strict\";\n\nvar Offset = function () {\n    this.values = [];\n};\n\nOffset.prototype.update = function (remoteTime) {\n    this.values.push((new Date()).getTime() - remoteTime.getTime());\n};\n\nOffset.prototype.localTime = function () {\n    return new Date((new Date()).getTime() - this.values.reduce(\n        function (a, b) { return a + b; }) / this.values.length);\n};\n\nvar offset = new Offset();\n\nmodule.exports = {\n    offset: offset,\n}\n","var config = require(\"app/config\");\n\nvar fa = require(\"app/i18n/fa\");\n\n\"use strict\";\n\nvar pluralforms = function (lang) {\n    return function (msgs, n) {\n        return msgs[n === 1 ? 0 : 1];\n    };\n};\n\nvar catalogue = {\n    fa: fa,\n};\n\n// for each entry in config.langs, see whether we have a catalogue\n// entry and a pluralforms entry for it.  if we don't, try chopping\n// off everything but the primary language subtag, before moving\n// on to the next one.\nvar lang, plural, translations;\nfor (var i = 0; i < config.langs.length; i++) {\n    lang = config.langs[i];\n    plural = pluralforms(lang);\n    translations = catalogue[lang];\n    if (plural && translations)\n        break;\n    if (/-/.test(lang)) {\n        lang = lang.split(\"-\", 1)[0];\n        plural = pluralforms(lang);\n        translations = catalogue[lang];\n        if (plural && translations)\n            break;\n    }\n}\n\n// absolute backstop; if we get here there's a bug in config.js\nif (!plural || !translations) {\n    lang = \"fa\";\n    plural = pluralforms(lang);\n    translations = catalogue[lang];\n}\n\nvar translate = function (msgid) {\n    return config[msgid + '-text-' + lang] ||\n        translations[msgid] ||\n        en[msgid] ||\n        \"[?\" + msgid + \"]\";\n};\n\nvar pluralize = function (msgid, n) {\n    var msg;\n\n    msg = translate(msgid);\n    if (msg.indexOf(\"\\n\") > -1) {\n        msg = plural(msg.split(\"\\n\"), (+ n));\n    }\n\n    return msg ? msg.replace(\"{{ n }}\", (+ n)) : msg;\n};\n\nvar ago = function (localTime, date) {\n\n    var secs = ((localTime.getTime() - date.getTime()) / 1000);\n\n    if (isNaN(secs) || secs < 0) {\n        secs = 0;\n    }\n\n    var mins = Math.floor(secs / 60), hours = Math.floor(mins / 60),\n        days = Math.floor(hours / 24);\n\n    return secs <= 45 && translate(\"date-now\") ||\n        secs <= 90 && pluralize(\"date-minute\", 1) ||\n        mins <= 45 && pluralize(\"date-minute\", mins) ||\n        mins <= 90 && pluralize(\"date-hour\", 1) ||\n        hours <= 22 && pluralize(\"date-hour\", hours) ||\n        hours <= 36 && pluralize(\"date-day\", 1) ||\n        days <= 5 && pluralize(\"date-day\", days) ||\n        days <= 8 && pluralize(\"date-week\", 1) ||\n        days <= 21 && pluralize(\"date-week\", Math.floor(days / 7)) ||\n        days <= 45 && pluralize(\"date-month\", 1) ||\n        days <= 345 && pluralize(\"date-month\", Math.floor(days / 30)) ||\n        days <= 547 && pluralize(\"date-year\", 1) ||\n        pluralize(\"date-year\", Math.floor(days / 365.25));\n};\n\nmodule.exports = {\n    ago: ago,\n    lang: lang,\n    translate: translate,\n    pluralize: pluralize,\n};\n","module.exports = {\n    \"postbox-text\": \"متن نظر را اینجا وارد کنید - حداقل ۳ حرف\",\n    \"postbox-author\": \"نام (اختیاری)\",\n    \"postbox-email\": \"آدرس ایمیل (اختیاری)\",\n    \"postbox-website\": \"آدرس وب سایت (اختیاری)\",\n    \"postbox-preview\": \"پیش نمایش\",\n    \"postbox-edit\": \"ویرایش\",\n    \"postbox-submit\": \"ثبت\",\n    \"postbox-notification\": \"اطلاع رسانی از طریق ایمیل\",\n\n    \"num-comments\": \"یک نظر\\n{{ n }} نظر\",\n    \"no-comments\": \"هنوز نظری ثبت نشده است\",\n    \"atom-feed\": \"فید اتم\",\n\n    \"comment-reply\": \"پاسخ\",\n    \"comment-edit\": \"ویرایش\",\n    \"comment-save\": \"ذخیره\",\n    \"comment-delete\": \"حذف\",\n    \"comment-confirm\": \"تایید\",\n    \"comment-close\": \"بستن\",\n    \"comment-cancel\": \"لغو\",\n    \"comment-deleted\": \"نظر حذف شد.\",\n    \"comment-queued\": \"در انتظار بررسی توسط مدیریت.\",\n    \"comment-anonymous\": \"ناشناس\",\n    \"comment-hidden\": \"{{ n }} مخفی\",\n\n    \"date-now\": \"همین الان\",\n    \"date-minute\": \"یک دقیقه پیش\\n{{ n }} دقیقه پیش\",\n    \"date-hour\": \"یک ساعت پیش\\n{{ n }} ساعت پیش\",\n    \"date-day\": \"دیروز\\n{{ n }} روز پیش\",\n    \"date-week\": \"هفته پیش\\n{{ n }} هفته پیش\",\n    \"date-month\": \"ماه پیش\\n{{ n }} ماه پیش\",\n    \"date-year\": \"سال پیش\\n{{ n }} سال پیش\",\n};\n","var Q = require(\"app/lib/promise\");\n\n(\"use strict\");\n\n// Number of squares width and height\nvar GRID = 5;\n\nvar pad = function (n, width) {\n    return n.length >= width\n        ? n\n        : new Array(width - n.length + 1).join(\"0\") + n;\n};\n\n/**\n * Fill in a square on the canvas.\n */\nvar fill = function (svg, x, y, padding, size, color) {\n    var rect = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\n\n    rect.setAttribute(\"x\", padding + x * size);\n    rect.setAttribute(\"y\", padding + y * size);\n    rect.setAttribute(\"width\", size);\n    rect.setAttribute(\"height\", size);\n    rect.setAttribute(\"style\", \"fill: \" + color);\n\n    svg.appendChild(rect);\n};\n\n/**\n * Pick random squares to fill in.\n */\nvar generateIdenticon = function (key, padding, size, config) {\n    var svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n    svg.setAttribute(\"version\", \"1.1\");\n    svg.setAttribute(\"viewBox\", \"0 0 \" + size + \" \" + size);\n    svg.setAttribute(\"preserveAspectRatio\", \"xMinYMin meet\");\n    svg.setAttribute(\"shape-rendering\", \"crispEdges\");\n    fill(svg, 0, 0, 0, size + 2 * padding, config[\"avatar-bg\"]);\n\n    if (typeof key === null) {\n        return svg;\n    }\n\n    Q.when(key, function (key) {\n        var hash = pad(\n                (parseInt(key.substr(-16), 16) % Math.pow(2, 18)).toString(2),\n                18\n            ),\n            index = 0;\n\n        svg.setAttribute(\"data-hash\", key);\n\n        var i = parseInt(hash.substring(hash.length - 3, hash.length), 2),\n            color = config[\"avatar-fg\"][i % config[\"avatar-fg\"].length];\n\n        for (var x = 0; x < Math.ceil(GRID / 2); x++) {\n            for (var y = 0; y < GRID; y++) {\n                if (hash.charAt(index) === \"1\") {\n                    fill(svg, x, y, padding, 8, color);\n\n                    // fill right sight symmetrically\n                    if (x < Math.floor(GRID / 2)) {\n                        fill(svg, GRID - 1 - x, y, padding, 8, color);\n                    }\n                }\n                index++;\n            }\n        }\n    });\n\n    return svg;\n};\n\n/* TODO: This function is currently unused and should be removed */\nvar generateBlank = function (height, width, config) {\n    var blank = parseInt(\n        [\n            0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, /* purple: */ 0, 1, 0,\n        ].join(\"\"),\n        2\n    ).toString(16);\n\n    var el = generateIdenticon(blank, height, width, config);\n    el.setAttribute(\"className\", \"blank\"); // IE10 does not support classList on SVG elements, duh.\n\n    return el;\n};\n\nmodule.exports = {\n    generate: generateIdenticon,\n    blank: generateBlank,\n};\n","\"use strict\";\n\nvar stderr = function (text) {\n    console.log(text);\n};\n\nvar Promise = function () {\n    this.success = [];\n    this.errors = [];\n};\n\nPromise.prototype.then = function (onSuccess, onError) {\n    this.success.push(onSuccess);\n    if (onError) {\n        this.errors.push(onError);\n    } else {\n        this.errors.push(stderr);\n    }\n};\n\nvar Defer = function () {\n    this.promise = new Promise();\n};\n\nDefer.prototype = {\n    promise: Promise,\n    resolve: function (rv) {\n        this.promise.success.forEach(function (callback) {\n            window.setTimeout(function () {\n                callback(rv);\n            }, 0);\n        });\n    },\n\n    reject: function (error) {\n        this.promise.errors.forEach(function (callback) {\n            window.setTimeout(function () {\n                callback(error);\n            }, 0);\n        });\n    },\n};\n\nvar when = function (obj, func) {\n    if (obj instanceof Promise) {\n        return obj.then(func);\n    } else {\n        return func(obj);\n    }\n};\n\nvar defer = function () {\n    return new Defer();\n};\n\nmodule.exports = {\n    defer: defer,\n    when: when,\n};\n","\"use strict\";\n\nvar loaded = false;\nvar once = function (callback) {\n    if (!loaded) {\n        loaded = true;\n        callback();\n    }\n};\n\nvar domready = function (callback) {\n    // HTML5 standard to listen for dom readiness\n    document.addEventListener(\"DOMContentLoaded\", function () {\n        once(callback);\n    });\n\n    // if dom is already ready, just run callback\n    if (\n        document.readyState === \"interactive\" ||\n        document.readyState === \"complete\"\n    ) {\n        once(callback);\n    }\n};\n\nmodule.exports = domready;\n","var $ = require(\"app/dom\");\nvar utils = require(\"app/utils\");\nvar config = require(\"app/config\");\nvar api = require(\"app/api\");\nvar template = require(\"app/template\");\nvar i18n = require(\"app/i18n\");\nvar identicons = require(\"app/lib/identicons\");\nvar globals = require(\"app/globals\");\n\n\"use strict\";\n\nvar editorify = function (el) {\n    el = $.htmlify(el);\n    el.setAttribute(\"contentEditable\", true);\n\n    el.on(\"focus\", function () {\n        if (el.classList.contains(\"nikas-placeholder\")) {\n            el.innerHTML = \"\";\n            el.classList.remove(\"nikas-placeholder\");\n        }\n    });\n\n    el.on(\"blur\", function () {\n        if (el.textContent.length === 0) {\n            el.textContent = i18n.translate(\"postbox-text\");\n            el.classList.add(\"nikas-placeholder\");\n        }\n    });\n\n    return el;\n}\n\nvar Postbox = function (parent) {\n\n    var localStorage = utils.localStorageImpl,\n        el = $.htmlify(template.render(\"postbox\", {\n            \"author\": JSON.parse(localStorage.getItem(\"nikas-author\")),\n            \"email\": JSON.parse(localStorage.getItem(\"nikas-email\")),\n            \"website\": JSON.parse(localStorage.getItem(\"nikas-website\")),\n            \"preview\": ''\n        }));\n\n    // callback on success (e.g. to toggle the reply button)\n    el.onsuccess = function () { };\n\n    el.validate = function () {\n        if (utils.text($(\".nikas-textarea\", this).innerHTML).length < 3 ||\n            $(\".nikas-textarea\", this).classList.contains(\"nikas-placeholder\")) {\n            $(\".nikas-textarea\", this).focus();\n            return false;\n        }\n        if (config[\"require-email\"] &&\n            $(\"[name='email']\", this).value.length <= 0) {\n            $(\"[name='email']\", this).focus();\n            return false;\n        }\n        if (config[\"require-author\"] &&\n            $(\"[name='author']\", this).value.length <= 0) {\n            $(\"[name='author']\", this).focus();\n            return false;\n        }\n        return true;\n    };\n\n    // only display notification checkbox if email is filled in\n    var email_edit = function () {\n        if (config[\"reply-notifications\"] && $(\"[name='email']\", el).value.length > 0) {\n            $(\".nikas-notification-section\", el).show();\n        } else {\n            $(\".nikas-notification-section\", el).hide();\n        }\n    };\n    $(\"[name='email']\", el).on(\"input\", email_edit);\n    email_edit();\n\n    // email is not optional if this config parameter is set\n    if (config[\"require-email\"]) {\n        $(\"[name='email']\", el).setAttribute(\"placeholder\",\n            $(\"[name='email']\", el).getAttribute(\"placeholder\").replace(/ \\(.*\\)/, \"\"));\n    }\n\n    // author is not optional if this config parameter is set\n    if (config[\"require-author\"]) {\n        $(\"[name='author']\", el).placeholder =\n            $(\"[name='author']\", el).placeholder.replace(/ \\(.*\\)/, \"\");\n    }\n\n    // preview function\n    $(\"[name='preview']\", el).on(\"click\", function () {\n        api.preview(utils.text($(\".nikas-textarea\", el).innerHTML)).then(\n            function (html) {\n                $(\".preview .text\", el).innerHTML = html;\n                el.classList.add('nikas-preview-mode');\n            });\n    });\n\n    // edit function\n    var edit = function () {\n        $(\".nikas-preview .nikas-text\", el).innerHTML = '';\n        el.classList.remove('nikas-preview-mode');\n    };\n    $(\"[name='edit']\", el).on(\"click\", edit);\n    $(\".nikas-preview\", el).on(\"click\", edit);\n\n    // submit form, initialize optional fields with `null` and reset form.\n    // If replied to a comment, remove form completely.\n    $(\"[type=submit]\", el).on(\"click\", function () {\n        edit();\n        if (!el.validate()) {\n            return;\n        }\n\n        var author = $(\"[name=author]\", el).value || null,\n            email = $(\"[name=email]\", el).value || null,\n            website = $(\"[name=website]\", el).value || null;\n\n        localStorage.setItem(\"nikas-author\", JSON.stringify(author));\n        localStorage.setItem(\"nikas-email\", JSON.stringify(email));\n        localStorage.setItem(\"nikas-website\", JSON.stringify(website));\n\n        api.create($(\"#nikas-thread\").getAttribute(\"data-nikas-id\"), {\n            author: author, email: email, website: website,\n            text: utils.text($(\".nikas-textarea\", el).innerHTML),\n            parent: parent || null,\n            title: $(\"#nikas-thread\").getAttribute(\"data-title\") || null,\n            notification: $(\"[name=notification]\", el).checked() ? 1 : 0,\n        }).then(function (comment) {\n            $(\".nikas-textarea\", el).innerHTML = \"\";\n            $(\".nikas-textarea\", el).blur();\n            insert(comment, true);\n\n            if (parent !== null) {\n                el.onsuccess();\n            }\n        });\n    });\n\n    editorify($(\".nikas-textarea\", el));\n\n    return el;\n};\n\nvar insert_loader = function (comment, lastcreated) {\n    var entrypoint;\n    if (comment.id === null) {\n        entrypoint = $(\"#nikas-root\");\n        comment.name = 'null';\n    } else {\n        entrypoint = $(\"#nikas-\" + comment.id + \" > .nikas-text-wrapper > .nikas-follow-up\");\n        comment.name = comment.id;\n    }\n    var el = $.htmlify(template.render(\"comment-loader\", { \"comment\": comment }));\n\n    entrypoint.append(el);\n\n    $(\"a.nikas-load-hidden\", el).on(\"click\", function () {\n        el.remove();\n        api.fetch($(\"#nikas-thread\").getAttribute(\"data-nikas-id\"),\n            config[\"reveal-on-click\"], config[\"max-comments-nested\"],\n            comment.id,\n            lastcreated).then(\n                function (rv) {\n                    if (rv.total_replies === 0) {\n                        return;\n                    }\n\n                    var lastcreated = 0;\n                    rv.replies.forEach(function (commentObject) {\n                        insert(commentObject, false);\n                        if (commentObject.created > lastcreated) {\n                            lastcreated = commentObject.created;\n                        }\n                    });\n\n                    if (rv.hidden_replies > 0) {\n                        insert_loader(rv, lastcreated);\n                    }\n                },\n                function (err) {\n                    console.log(err);\n                });\n    });\n};\n\nvar insert = function (comment, scrollIntoView) {\n    var el = $.htmlify(template.render(\"comment\", { \"comment\": comment }));\n\n    // update datetime every 60 seconds\n    var refresh = function () {\n        $(\".nikas-permalink > time\", el).textContent = i18n.ago(\n            globals.offset.localTime(), new Date(parseInt(comment.created, 10) * 1000));\n        setTimeout(refresh, 60 * 1000);\n    };\n\n    // run once to activate\n    refresh();\n\n    if (config[\"avatar\"]) {\n        $(\".nikas-avatar > svg\", el).replace(identicons.generate(comment.hash, 4, 48, config));\n    }\n\n    var entrypoint;\n    if (comment.parent === null) {\n        entrypoint = $(\"#nikas-root\");\n    } else {\n        entrypoint = $(\"#nikas-\" + comment.parent + \" > .nikas-text-wrapper > .nikas-follow-up\");\n    }\n\n    entrypoint.append(el);\n\n    if (scrollIntoView) {\n        el.scrollIntoView();\n    }\n\n    var footer = $(\"#nikas-\" + comment.id + \" > .nikas-text-wrapper > .nikas-comment-footer\"),\n        header = $(\"#nikas-\" + comment.id + \" > .nikas-text-wrapper > .nikas-comment-header\"),\n        text = $(\"#nikas-\" + comment.id + \" > .nikas-text-wrapper > .nikas-text\");\n\n    var form = null;  // XXX: probably a good place for a closure\n    $(\"a.nikas-reply\", footer).toggle(\"click\",\n        function (toggler) {\n            form = footer.insertAfter(new Postbox(comment.parent === null ? comment.id : comment.parent));\n            form.onsuccess = function () { toggler.next(); };\n            $(\".nikas-textarea\", form).focus();\n            $(\"a.nikas-reply\", footer).textContent = i18n.translate(\"comment-close\");\n        },\n        function () {\n            form.remove();\n            $(\"a.nikas-reply\", footer).textContent = i18n.translate(\"comment-reply\");\n        }\n    );\n\n    if (config.vote) {\n        var voteLevels = config['vote-levels'];\n        if (typeof voteLevels === 'string') {\n            // Eg. -5,5,15\n            voteLevels = voteLevels.split(',');\n        }\n\n        // update vote counter\n        var votes = function (value) {\n            var span = $(\"span.nikas-votes\", footer);\n            if (span === null) {\n                footer.prepend($.new(\"span.nikas-votes\", value));\n            } else {\n                span.textContent = value;\n            }\n            if (value) {\n                el.classList.remove('nikas-no-votes');\n            } else {\n                el.classList.add('nikas-no-votes');\n            }\n            if (voteLevels) {\n                var before = true;\n                for (var index = 0; index <= voteLevels.length; index++) {\n                    if (before && (index >= voteLevels.length || value < voteLevels[index])) {\n                        el.classList.add('nikas-vote-level-' + index);\n                        before = false;\n                    } else {\n                        el.classList.remove('nikas-vote-level-' + index);\n                    }\n                }\n            }\n        };\n\n        $(\"a.nikas-upvote\", footer).on(\"click\", function () {\n            api.like(comment.id).then(function (rv) {\n                votes(rv.likes - rv.dislikes);\n            });\n        });\n\n        $(\"a.nikas-downvote\", footer).on(\"click\", function () {\n            api.dislike(comment.id).then(function (rv) {\n                votes(rv.likes - rv.dislikes);\n            });\n        });\n\n        votes(comment.likes - comment.dislikes);\n    }\n\n    $(\"a.nikas-edit\", footer).toggle(\"click\",\n        function (toggler) {\n            var edit = $(\"a.nikas-edit\", footer);\n            var avatar = config[\"avatar\"] || config[\"gravatar\"] ? $(\".nikas-avatar\", el, false)[0] : null;\n\n            edit.textContent = i18n.translate(\"comment-save\");\n            edit.insertAfter($.new(\"a.nikas-cancel\", i18n.translate(\"comment-cancel\"))).on(\"click\", function () {\n                toggler.canceled = true;\n                toggler.next();\n            });\n\n            toggler.canceled = false;\n            api.view(comment.id, 1).then(function (rv) {\n                var textarea = editorify($.new(\"div.nikas-textarea\"));\n\n                textarea.innerHTML = utils.detext(rv.text);\n                textarea.focus();\n\n                text.classList.remove(\"nikas-text\");\n                text.classList.add(\"nikas-textarea-wrapper\");\n\n                text.textContent = \"\";\n                text.append(textarea);\n            });\n\n            if (avatar !== null) {\n                avatar.hide();\n            }\n        },\n        function (toggler) {\n            var textarea = $(\".nikas-textarea\", text);\n            var avatar = config[\"avatar\"] || config[\"gravatar\"] ? $(\".nikas-avatar\", el, false)[0] : null;\n\n            if (!toggler.canceled && textarea !== null) {\n                if (utils.text(textarea.innerHTML).length < 3) {\n                    textarea.focus();\n                    toggler.wait();\n                    return;\n                } else {\n                    api.modify(comment.id, { \"text\": utils.text(textarea.innerHTML) }).then(function (rv) {\n                        text.innerHTML = rv.text;\n                        comment.text = rv.text;\n                    });\n                }\n            } else {\n                text.innerHTML = comment.text;\n            }\n\n            text.classList.remove(\"nikas-textarea-wrapper\");\n            text.classList.add(\"nikas-text\");\n\n            if (avatar !== null) {\n                avatar.show();\n            }\n\n            $(\"a.nikas-cancel\", footer).remove();\n            $(\"a.nikas-edit\", footer).textContent = i18n.translate(\"comment-edit\");\n        }\n    );\n\n    $(\"a.nikas-delete\", footer).toggle(\"click\",\n        function (toggler) {\n            var del = $(\"a.nikas-delete\", footer);\n            var state = !toggler.state;\n\n            del.textContent = i18n.translate(\"comment-confirm\");\n            del.on(\"mouseout\", function () {\n                del.textContent = i18n.translate(\"comment-delete\");\n                toggler.state = state;\n                del.onmouseout = null;\n            });\n        },\n        function () {\n            var del = $(\"a.nikas-delete\", footer);\n            api.remove(comment.id).then(function (rv) {\n                if (rv) {\n                    el.remove();\n                } else {\n                    $(\"span.nikas-note\", header).textContent = i18n.translate(\"comment-deleted\");\n                    text.innerHTML = \"<p>&nbsp;</p>\";\n                    $(\"a.nikas-edit\", footer).remove();\n                    $(\"a.nikas-delete\", footer).remove();\n                }\n                del.textContent = i18n.translate(\"comment-delete\");\n            });\n        }\n    );\n\n    // remove edit and delete buttons when cookie is gone\n    var clear = function (button) {\n        if (!utils.cookie(\"nikas-\" + comment.id)) {\n            if ($(button, footer) !== null) {\n                $(button, footer).remove();\n            }\n        } else {\n            setTimeout(function () { clear(button); }, 15 * 1000);\n        }\n    };\n\n    clear(\"a.nikas-edit\");\n    clear(\"a.nikas-delete\");\n\n    // show direct reply to own comment when cookie is max aged\n    var show = function (el) {\n        if (utils.cookie(\"nikas-\" + comment.id)) {\n            setTimeout(function () { show(el); }, 15 * 1000);\n        } else {\n            footer.append(el);\n        }\n    };\n\n    if (!config[\"reply-to-self\"] && utils.cookie(\"nikas-\" + comment.id)) {\n        show($(\"a.nikas-reply\", footer).detach());\n    }\n\n    if (comment.hasOwnProperty('replies')) {\n        var lastcreated = 0;\n        comment.replies.forEach(function (replyObject) {\n            insert(replyObject, false);\n            if (replyObject.created > lastcreated) {\n                lastcreated = replyObject.created;\n            }\n\n        });\n        if (comment.hidden_replies > 0) {\n            insert_loader(comment, lastcreated);\n        }\n\n    }\n\n};\n\nmodule.exports = {\n    insert: insert,\n    insert_loader: insert_loader,\n    Postbox: Postbox,\n};\n","module.exports = {\n    \"arrow-down\": require(\"app/svg/arrow-down.svg\"),\n    \"arrow-up\": require(\"app/svg/arrow-up.svg\"),\n};\n","var utils = require(\"app/utils\");\n\nvar tmpl_postbox = require(\"app/templates/postbox\");\nvar tmpl_comment = require(\"app/templates/comment\");\nvar tmpl_comment_loader = require(\"app/templates/comment-loader\");\n\n\"use strict\";\n\nvar globals = {},\n    templates = {};\n\nvar load_tmpl = function (name, tmpl) {\n    templates[name] = tmpl;\n};\n\nvar set = function (name, value) {\n    globals[name] = value;\n};\n\nload_tmpl(\"postbox\", tmpl_postbox);\nload_tmpl(\"comment\", tmpl_comment);\nload_tmpl(\"comment-loader\", tmpl_comment_loader);\n\nset(\"bool\", function (arg) { return arg ? true : false; });\nset(\"humanize\", function (date) {\n    if (typeof date !== \"object\") {\n        date = new Date(parseInt(date, 10) * 1000);\n    }\n\n    return date.toString();\n});\nset(\"datetime\", function (date) {\n    if (typeof date !== \"object\") {\n        date = new Date(parseInt(date, 10) * 1000);\n    }\n\n    return [\n        date.getUTCFullYear(),\n        utils.pad(date.getUTCMonth(), 2),\n        utils.pad(date.getUTCDay(), 2)\n    ].join(\"-\") + \"T\" + [\n        utils.pad(date.getUTCHours(), 2),\n        utils.pad(date.getUTCMinutes(), 2),\n        utils.pad(date.getUTCSeconds(), 2)\n    ].join(\":\") + \"Z\";\n});\n\nvar render = function (name, locals) {\n    var rv, t = templates[name];\n    if (!t) {\n        throw new Error(\"Template not found: '\" + name + \"'\");\n    }\n\n    locals = locals || {};\n\n    var keys = [];\n    for (var key in locals) {\n        if (locals.hasOwnProperty(key) && !globals.hasOwnProperty(key)) {\n            keys.push(key);\n            globals[key] = locals[key];\n        }\n    }\n\n    rv = templates[name](globals);\n\n    // These are all needed, else DOM.htmlify will fail to create the element!\n    // Strip newlines rendered from template literals\n    rv = rv.replace(/\\r?\\n|\\r/g, \" \");\n    // Trim whitespace\n    rv = rv.trim();\n\n    for (var i = 0; i < keys.length; i++) {\n        delete globals[keys[i]];\n    }\n\n    return rv;\n};\n\nmodule.exports = {\n    set: set,\n    render: render,\n};\n","var html = function (globals) {\n    var comment = globals.comment;\n    var pluralize = globals.pluralize;\n\n    return (\n        \"\" +\n        \"<div class='nikas-comment-loader' id='nikas-loader-\" +\n        comment.name +\n        \"'>\" +\n        \"<a class='nikas-load-hidden' href='#'>\" +\n        pluralize(\"comment-hidden\", comment.hidden_replies) +\n        \"</a>\" +\n        \"</div>\"\n    );\n};\nmodule.exports = html;\n","var html = function (globals) {\n    var i18n = globals.i18n;\n    var comment = globals.comment;\n    var conf = globals.conf;\n    var datetime = globals.datetime;\n    var humanize = globals.humanize;\n    var svg = globals.svg;\n\n    var author = comment.author ? comment.author : i18n(\"comment-anonymous\");\n\n    return (\n        \"\" +\n        \"<div class='nikas-comment' id='nikas-\" +\n        comment.id +\n        \"'>\" +\n        (conf.gravatar\n            ? \"<div class='nikas-avatar'><img src='\" +\n              comment.gravatar_image +\n              \"'></div>\"\n            : \"\") +\n        (conf.avatar\n            ? \"<div class='nikas-avatar'><svg data-hash='\" +\n              comment.hash +\n              \"'</svg></div>\"\n            : \"\") +\n        \"<div class='nikas-text-wrapper'>\" +\n        \"<div class='nikas-comment-header' role='meta'>\" +\n        (comment.website\n            ? \"<a class='nikas-author' href='\" +\n              comment.website +\n              \"' rel='nofollow'>\" +\n              author +\n              \"</a>\"\n            : \"<span class='nikas-author'>\" + author + \"</span>\") +\n        \"<span class='nikas-spacer'>&bull;</span>\" +\n        \"<a class='nikas-permalink' href='#nikas-\" +\n        comment.id +\n        \"'>\" +\n        \"<time title='\" +\n        humanize(comment.created) +\n        \"' datetime='\" +\n        datetime(comment.created) +\n        \"'>\" +\n        humanize(comment.created) +\n        \"</time>\" +\n        \"</a>\" +\n        \"<span class='nikas-note'>\" +\n        (comment.mode == 2\n            ? i18n(\"comment-queued\")\n            : comment.mode == 4\n            ? i18n(\"comment-deleted\")\n            : \"\") +\n        \"</span>\" +\n        \"</div>\" + // .text-wrapper\n        \"<div class='nikas-text'>\" +\n        (comment.mode == 4 ? \"<p>&nbsp;</p>\" : comment.text) +\n        \"</div>\" + // .text\n        \"<div class='nikas-comment-footer'>\" +\n        (conf.vote\n            ? \"<a class='nikas-upvote' href='#'>\" +\n              svg[\"arrow-up\"] +\n              \"</a>\" +\n              \"<span class='nikas-spacer'>|</span>\" +\n              \"<a class='nikas-downvote' href='#'>\" +\n              svg[\"arrow-down\"] +\n              \"</a>\"\n            : \"\") +\n        \"<a class='nikas-reply' href='#'>\" +\n        i18n(\"comment-reply\") +\n        \"</a>\" +\n        \"<a class='nikas-edit' href='#'>\" +\n        i18n(\"comment-edit\") +\n        \"</a>\" +\n        \"<a class='nikas-delete' href='#'>\" +\n        i18n(\"comment-delete\") +\n        \"</a>\" +\n        \"</div>\" + // .nikas-comment-footer\n        \"<div class='nikas-follow-up'></div>\" +\n        \"</div>\" + // .text-wrapper\n        \"</div>\"\n    ); // .nikas-comment\n};\nmodule.exports = html;\n","var html = function (globals) {\n    var i18n = globals.i18n;\n    var author = globals.author;\n    var email = globals.email;\n    var website = globals.website;\n\n    return (\n        \"\" +\n        \"<div class='nikas-postbox'>\" +\n        \"<div class='nikas-form-wrapper'>\" +\n        \"<div class='nikas-textarea-wrapper'>\" +\n        \"<div class='nikas-textarea nikas-placeholder' contenteditable='true'>\" +\n        i18n(\"postbox-text\") +\n        \"</div>\" +\n        \"<div class='nikas-preview'>\" +\n        \"<div class='nikas-comment'>\" +\n        \"<div class='nikas-text-wrapper'>\" +\n        \"<div class='nikas-text'></div>\" +\n        \"</div>\" +\n        \"</div>\" +\n        \"</div>\" +\n        \"</div>\" +\n        \"<section class='nikas-auth-section'>\" +\n        \"<p class='nikas-input-wrapper'>\" +\n        \"<input type='text' name='author' placeholder='\" +\n        i18n(\"postbox-author\") +\n        \"' value='\" +\n        (author ? author : \"\") +\n        \"' />\" +\n        \"</p>\" +\n        \"<p class='nikas-input-wrapper'>\" +\n        \"<input type='email' name='email' placeholder='\" +\n        i18n(\"postbox-email\") +\n        \"' value='\" +\n        (email ? email : \"\") +\n        \"' />\" +\n        \"</p>\" +\n        \"<p class='nikas-input-wrapper'>\" +\n        \"<input type='text' name='website' placeholder='\" +\n        i18n(\"postbox-website\") +\n        \"' value='\" +\n        (website ? website : \"\") +\n        \"' />\" +\n        \"</p>\" +\n        \"<p class='nikas-post-action'>\" +\n        \"<input type='submit' value='\" +\n        i18n(\"postbox-submit\") +\n        \"' />\" +\n        \"</p>\" +\n        \"<p class='nikas-post-action'>\" +\n        \"<input type='button' name='preview' value='\" +\n        i18n(\"postbox-preview\") +\n        \"' />\" +\n        \"</p>\" +\n        \"<p class='nikas-post-action'>\" +\n        \"<input type='button' name='edit' value='\" +\n        i18n(\"postbox-edit\") +\n        \"' />\" +\n        \"</p>\" +\n        \"</section>\" +\n        \"<section class='nikas-notification-section'>\" +\n        \"<label>\" +\n        \"<input type='checkbox' name='notification' />\" +\n        i18n(\"postbox-notification\") +\n        \"</label>\" +\n        \"</section>\" +\n        \"</div>\" +\n        \"</div>\"\n    );\n};\nmodule.exports = html;\n","\"use strict\";\n\n// return `cookie` string if set\nvar cookie = function (cookie) {\n    return (document.cookie.match('(^|; )' + cookie + '=([^;]*)') || 0)[2];\n};\n\nvar pad = function (n, width, z) {\n    z = z || '0';\n    n = n + '';\n    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;\n};\n\nvar HTMLEntity = {\n    \"&\": \"&amp;\",\n    \"<\": \"&lt;\",\n    \">\": \"&gt;\",\n    '\"': '&quot;',\n    \"'\": '&#39;',\n    \"/\": '&#x2F;'\n};\n\nvar escape = function (html) {\n    return String(html).replace(/[&<>\"'\\/]/g, function (s) {\n        return HTMLEntity[s];\n    });\n};\n\nvar text = function (html) {\n    var _ = document.createElement(\"div\");\n    _.innerHTML = html.replace(/<div><br><\\/div>/gi, '<br>')\n        .replace(/<div>/gi, '<br>')\n        .replace(/<br>/gi, '\\n')\n        .replace(/&nbsp;/gi, ' ');\n    return _.textContent.trim();\n};\n\nvar detext = function (text) {\n    text = escape(text);\n    return text.replace(/\\n\\n/gi, '<br><div><br></div>')\n        .replace(/\\n/gi, '<br>');\n};\n\n// Normalize a BCP47 language tag.\n// Quoting https://tools.ietf.org/html/bcp47 :\n//   An implementation can reproduce this format without accessing\n//   the registry as follows.  All subtags, including extension\n//   and private use subtags, use lowercase letters with two\n//   exceptions: two-letter and four-letter subtags that neither\n//   appear at the start of the tag nor occur after singletons.\n//   Such two-letter subtags are all uppercase (as in the tags\n//   \"en-CA-x-ca\" or \"sgn-BE-FR\") and four-letter subtags are\n//   titlecase (as in the tag \"az-Latn-x-latn\").\n// We also map underscores to dashes.\nvar normalize_bcp47 = function (tag) {\n    var subtags = tag.toLowerCase().split(/[_-]/);\n    var afterSingleton = false;\n    for (var i = 0; i < subtags.length; i++) {\n        if (subtags[i].length === 1) {\n            afterSingleton = true;\n        } else if (afterSingleton || i === 0) {\n            afterSingleton = false;\n        } else if (subtags[i].length === 2) {\n            subtags[i] = subtags[i].toUpperCase();\n        } else if (subtags[i].length === 4) {\n            subtags[i] = subtags[i].charAt(0).toUpperCase()\n                + subtags[i].substr(1);\n        }\n    }\n    return subtags.join(\"-\");\n};\n\n// Safari private browsing mode supports localStorage, but throws QUOTA_EXCEEDED_ERR\nvar localStorageImpl;\ntry {\n    localStorage.setItem(\"x\", \"y\");\n    localStorage.removeItem(\"x\");\n    localStorageImpl = localStorage;\n} catch (ex) {\n    localStorageImpl = (function (storage) {\n        return {\n            setItem: function (key, val) {\n                storage[key] = val;\n            },\n            getItem: function (key) {\n                return typeof (storage[key]) !== 'undefined' ? storage[key] : null;\n            },\n            removeItem: function (key) {\n                delete storage[key];\n            }\n        };\n    })({});\n}\n\nmodule.exports = {\n    cookie: cookie,\n    detext: detext,\n    localStorageImpl: localStorageImpl,\n    normalize_bcp47: normalize_bcp47,\n    pad: pad,\n    text: text,\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","var domready = require(\"app/lib/ready\");\nvar config = require(\"app/config\");\nvar i18n = require(\"app/i18n\");\nvar api = require(\"app/api\");\nvar nikas = require(\"app/nikas\");\nvar count = require(\"app/count\");\nvar $ = require(\"app/dom\");\nvar svg = require(\"app/svg\");\nvar template = require(\"app/template\");\n\n\"use strict\";\n\ntemplate.set(\"conf\", config);\ntemplate.set(\"i18n\", i18n.translate);\ntemplate.set(\"pluralize\", i18n.pluralize);\ntemplate.set(\"svg\", svg);\n\nvar nikas_thread;\nvar heading;\n\nfunction init () {\n    nikas_thread = $('#nikas-thread');\n    heading = $.new(\"h4\");\n\n    if (config[\"css\"] && $(\"style#nikas-style\") === null) {\n        var style = $.new(\"link\");\n        style.id = \"nikas-style\";\n        style.rel = \"stylesheet\";\n        style.type = \"text/css\";\n        style.href = config[\"css-url\"] ? config[\"css-url\"] : api.endpoint + \"/css/nikas.css\";\n        $(\"head\").append(style);\n    }\n\n    count();\n\n    if (nikas_thread === null) {\n        return console.log(\"abort, #nikas-thread is missing\");\n    }\n\n    if (config[\"feed\"]) {\n        var feedLink = $.new('a', i18n.translate('atom-feed'));\n        var feedLinkWrapper = $.new('span.nikas-feedlink');\n        feedLink.href = api.feed(nikas_thread.getAttribute(\"data-nikas-id\"));\n        feedLinkWrapper.appendChild(feedLink);\n        nikas_thread.append(feedLinkWrapper);\n    }\n    // Note: Not appending the nikas.Postbox here since it relies\n    // on the config object populated by elements fetched from the server,\n    // and the call to fetch those is in fetchComments()\n    nikas_thread.append(heading);\n    nikas_thread.append('<div id=\"nikas-root\"></div>');\n}\n\nfunction fetchComments () {\n    if (!$('#nikas-root')) {\n        return;\n    }\n\n    var nikas_root = $('#nikas-root');\n    nikas_root.textContent = '';\n    api.fetch(nikas_thread.getAttribute(\"data-nikas-id\") || location.pathname,\n        config[\"max-comments-top\"],\n        config[\"max-comments-nested\"]).then(\n            function (rv) {\n                for (var setting in rv.config) {\n                    if (setting in config && config[setting] != rv.config[setting]) {\n                        console.log(\"Nikas: Client value '%s' for setting '%s' overridden by server value '%s'.\\n\" +\n                            \"Since Nikas version 0.12.6, 'data-nikas-%s' is only configured via the server \" +\n                            \"to keep client and server in sync\",\n                            config[setting], setting, rv.config[setting], setting);\n                    }\n                    config[setting] = rv.config[setting]\n                }\n\n                // Note: nikas.Postbox relies on the config object populated by elements\n                // fetched from the server, so it cannot be created in init()\n                nikas_root.prepend(new nikas.Postbox(null));\n\n                if (rv.total_replies === 0) {\n                    heading.textContent = i18n.translate(\"no-comments\");\n                    return;\n                }\n\n                var lastcreated = 0;\n                var count = rv.total_replies;\n                rv.replies.forEach(function (comment) {\n                    nikas.insert(comment, false);\n                    if (comment.created > lastcreated) {\n                        lastcreated = comment.created;\n                    }\n                    count = count + comment.total_replies;\n                });\n                heading.textContent = i18n.pluralize(\"num-comments\", count);\n\n                if (rv.hidden_replies > 0) {\n                    nikas.insert_loader(rv, lastcreated);\n                }\n\n                if (window.location.hash.length > 0 &&\n                    window.location.hash.match(\"^#nikas-[0-9]+$\")) {\n                    $(window.location.hash).scrollIntoView();\n                }\n            },\n            function (err) {\n                console.log(err);\n            }\n        );\n}\n\ndomready(function () {\n    init();\n    fetchComments();\n});\n\nwindow.Nikas = {\n    init: init,\n    fetchComments: fetchComments\n};\n"],"names":[],"sourceRoot":""}